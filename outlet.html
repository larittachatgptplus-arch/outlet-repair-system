<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Outlet - Sistem Perbaikan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üè™ Portal Outlet</h1>
            <p>Laporkan kerusakan dan pantau status perbaikan</p>
            <button class="btn btn-warning" onclick="window.location.href='index.html'">‚¨Ö Kembali ke Home</button>
        </header>

        <main class="main-content">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('report')">üìù Lapor Kerusakan</button>
                <button class="tab-btn" onclick="switchTab('status')">üìä Lihat Status</button>
            </div>

            <!-- Tab 1: Lapor Kerusakan -->
            <div id="reportTab" class="tab-content active">
                <h2>üìù Form Laporan Kerusakan</h2>
                <p class="subtitle">Isi form di bawah untuk melaporkan kerusakan di outlet Anda</p>

                <div id="alertContainer"></div>

                <form id="reportForm">
                    <div class="form-group">
                        <label for="hub">üè¢ HUB *</label>
                        <select id="hub" required>
                            <option value="">-- Loading HUB... --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="outlet">üè™ Outlet *</label>
                        <select id="outlet" required disabled>
                            <option value="">-- Pilih HUB terlebih dahulu --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="kategori">üîß Kategori Kerusakan *</label>
                        <select id="kategori" required>
                            <option value="">-- Pilih Kategori --</option>
                            <option value="Listrik">Listrik</option>
                            <option value="AC (Air Conditioner)">AC (Air Conditioner)</option>
                            <option value="Bangunan">Bangunan (struktur, dinding, atap)</option>
                            <option value="Peralatan">Peralatan (mesin, freezer, dll)</option>
                            <option value="Display">Display (etalase, rak)</option>
                            <option value="Sanitasi">Sanitasi (kamar mandi, wastafel)</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="deskripsi">üìù Deskripsi Kerusakan *</label>
                        <textarea id="deskripsi" rows="4" required 
                                  placeholder="Jelaskan detail kerusakan, lokasi spesifik di outlet, dan dampaknya terhadap operasional"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="urgensi">‚ö†Ô∏è Tingkat Urgensi *</label>
                        <select id="urgensi" required>
                            <option value="">-- Pilih Tingkat Urgensi --</option>
                            <option value="Urgent">Urgent (mengganggu operasional, butuh segera)</option>
                            <option value="Tidak Urgent">Tidak Urgent (tidak mengganggu, tapi perlu diperbaiki)</option>
                            <option value="Bisa Belakangan">Bisa Belakangan (minor, bisa dijadwalkan fleksibel)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="linkFoto">üì∏ Link Foto Kerusakan *</label>
                        <input type="url" id="linkFoto" required
                               placeholder="https://drive.google.com/file/d/...">
                        <small style="color: #666; display: block; margin-top: 8px;">
                            üìå <strong>Cara upload foto ke Google Drive:</strong><br>
                            1. Buka Google Drive ‚Üí Upload foto kerusakan<br>
                            2. Klik kanan foto ‚Üí "Get link" ‚Üí Set "Anyone with the link"<br>
                            3. Copy link ‚Üí Paste di form ini<br>
                            <em>Atau gunakan link foto dari WhatsApp/platform lain</em>
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                        üöÄ Submit Laporan
                    </button>
                </form>
            </div>

            <!-- Tab 2: Lihat Status -->
            <div id="statusTab" class="tab-content">
                <h2>üìä Status Ticket Anda</h2>
                <p class="subtitle">Pilih outlet untuk melihat semua ticket yang pernah dilaporkan</p>

                <div class="form-group">
                    <label for="outletFilter">üè™ Pilih Outlet:</label>
                    <select id="outletFilter">
                        <option value="">-- Pilih Outlet --</option>
                    </select>
                </div>

                <div id="ticketContainer">
                    <p class="text-center text-muted">Pilih outlet untuk melihat status ticket</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Laritta Bakery - Sistem Perbaikan Outlet</p>
        </footer>
    </div>

    <script src="config.js"></script>
    <script>
        // Load data saat halaman dibuka
        document.addEventListener('DOMContentLoaded', function() {
            loadHubList();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('hub').addEventListener('change', function() {
                loadOutletsByHub(this.value);
            });
            
            document.getElementById('reportForm').addEventListener('submit', handleFormSubmit);
            
            document.getElementById('outletFilter').addEventListener('change', function() {
                loadTicketStatus(this.value);
            });
        }

        async function loadHubList() {
            const hubSelect = document.getElementById('hub');
            const outletFilterSelect = document.getElementById('outletFilter');
            
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}?action=getHubs`);
                const data = await response.json();
                
                if (data.success && data.hubs) {
                    populateHubDropdown(data.hubs);
                    populateOutletFilter(data.hubs);
                } else {
                    throw new Error('Backend not available');
                }
            } catch (error) {
                console.log('Using fallback data');
                populateHubDropdown(CONFIG.FALLBACK_DATA.hubs);
                populateOutletFilter(CONFIG.FALLBACK_DATA.hubs);
            }
        }

        function populateHubDropdown(hubs) {
            const hubSelect = document.getElementById('hub');
            hubSelect.innerHTML = '<option value="">-- Pilih HUB --</option>';
            
            hubs.forEach(hub => {
                const option = document.createElement('option');
                option.value = hub;
                option.textContent = hub;
                hubSelect.appendChild(option);
            });
        }

        function populateOutletFilter(hubs) {
            const outletFilterSelect = document.getElementById('outletFilter');
            
            hubs.forEach(hub => {
                loadOutletsByHubForFilter(hub, outletFilterSelect);
            });
        }

        async function loadOutletsByHub(hub) {
            const outletSelect = document.getElementById('outlet');
            
            if (!hub) {
                outletSelect.innerHTML = '<option value="">-- Pilih HUB terlebih dahulu --</option>';
                outletSelect.disabled = true;
                return;
            }
            
            outletSelect.innerHTML = '<option value="">‚è≥ Loading...</option>';
            outletSelect.disabled = true;
            
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}?action=getOutlets&hub=${encodeURIComponent(hub)}`);
                const data = await response.json();
                
                if (data.success && data.outlets) {
                    populateOutletDropdown(data.outlets);
                } else {
                    throw new Error('Backend not available');
                }
            } catch (error) {
                console.log('Using fallback data');
                const outlets = CONFIG.FALLBACK_DATA.outlets[hub] || [];
                populateOutletDropdown(outlets);
            }
        }

        function populateOutletDropdown(outlets) {
            const outletSelect = document.getElementById('outlet');
            outletSelect.innerHTML = '<option value="">-- Pilih Outlet --</option>';
            
            if (outlets.length === 0) {
                outletSelect.innerHTML = '<option value="">Tidak ada outlet untuk HUB ini</option>';
                return;
            }
            
            outlets.forEach(outlet => {
                const option = document.createElement('option');
                option.value = outlet;
                option.textContent = outlet;
                outletSelect.appendChild(option);
            });
            
            outletSelect.disabled = false;
        }

        async function loadOutletsByHubForFilter(hub, selectElement) {
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}?action=getOutlets&hub=${encodeURIComponent(hub)}`);
                const data = await response.json();
                
                if (data.success && data.outlets) {
                    data.outlets.forEach(outlet => {
                        const option = document.createElement('option');
                        option.value = outlet;
                        option.textContent = `${outlet} (${hub})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.log('Error loading outlets for filter');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            
            try {
                const formData = {
                    ticketId: generateTicketID(),
                    timestamp: new Date().toISOString(),
                    hub: document.getElementById('hub').value,
                    outlet: document.getElementById('outlet').value,
                    kategori: document.getElementById('kategori').value,
                    deskripsi: document.getElementById('deskripsi').value,
                    urgensi: document.getElementById('urgensi').value,
                    linkFoto: document.getElementById('linkFoto').value,
                    status: 'Menunggu Approval'
                };
                
                const response = await fetch(CONFIG.BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'submitTicket',
                        data: formData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `‚úÖ Ticket berhasil dibuat! Nomor ticket: ${formData.ticketId}`);
                    document.getElementById('reportForm').reset();
                    document.getElementById('outlet').disabled = true;
                } else {
                    throw new Error(result.message || 'Submit failed');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('danger', '‚ùå Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Submit Laporan';
            }
        }

        async function loadTicketStatus(outlet) {
            if (!outlet) return;
            
            const container = document.getElementById('ticketContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}?action=getTickets&outlet=${encodeURIComponent(outlet)}`);
                const data = await response.json();
                
                if (data.success && data.tickets) {
                    displayTickets(data.tickets);
                } else {
                    throw new Error('Failed to load tickets');
                }
            } catch (error) {
                container.innerHTML = '<p class="text-center text-muted">Error loading tickets</p>';
            }
        }

        function displayTickets(tickets) {
            const container = document.getElementById('ticketContainer');
            
            if (tickets.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Belum ada ticket untuk outlet ini</p>';
                return;
            }
            
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Tanggal</th>
                            <th>Kategori</th>
                            <th>Urgensi</th>
                            <th>Status</th>
                            <th>PIC</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tickets.forEach(ticket => {
                const urgencyClass = ticket.urgensi === 'Urgent' ? 'badge-urgent' : 
                                    ticket.urgensi === 'Tidak Urgent' ? 'badge-normal' : 'badge-low';
                const statusClass = ticket.status === 'Selesai' ? 'badge-done' :
                                  ticket.status === 'On Progress' ? 'badge-progress' :
                                  ticket.status === 'Ditolak' ? 'badge-rejected' : 'badge-pending';
                
                html += `
                    <tr>
                        <td><strong>${ticket.ticketId}</strong></td>
                        <td>${formatDate(ticket.timestamp)}</td>
                        <td>${ticket.kategori}</td>
                        <td><span class="badge ${urgencyClass}">${ticket.urgensi}</span></td>
                        <td><span class="badge ${statusClass}">${ticket.status}</span></td>
                        <td>${ticket.picTeknisi || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tabName === 'report') {
                document.getElementById('reportTab').classList.add('active');
                document.querySelector('.tab-btn:first-child').classList.add('active');
            } else {
                document.getElementById('statusTab').classList.add('active');
                document.querySelector('.tab-btn:last-child').classList.add('active');
            }
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
